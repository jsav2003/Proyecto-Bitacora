{% extends 'registros/base.html' %}
{% load static %}

{% block title %}Análisis de Regresión - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'registros/css/analisis_dashboard.css' %}?v=20251023-responsive-fix">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado Principal -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-dark mb-2">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Análisis de Regresión Lineal
                </h1>
                <p class="lead text-muted mb-0">
                    Modelado del crecimiento de plantas de frijol mediante técnicas estadísticas
                </p>
            </div>
            
            <!-- Barra de Búsqueda y Filtros -->
            <div class="card shadow-sm border-0 mb-4 filter-card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="fas fa-filter text-success me-2"></i>
                        Filtros y Búsqueda
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="get" action="{% url 'analisis_dashboard' %}">
                        <div class="row g-3 mb-3">
                            <!-- Búsqueda por nombre -->
                            <div class="col-12 col-lg-6">
                                <label for="buscar" class="form-label fw-semibold">
                                    <i class="fas fa-search text-success me-1"></i> Buscar estudiante
                                </label>
                                <input type="text" 
                                       class="form-control form-control-lg" 
                                       id="buscar" 
                                       name="buscar" 
                                       placeholder="Escribe el nombre del estudiante..." 
                                       value="{{ busqueda }}">
                            </div>
                            
                            <!-- Filtro por grupo -->
                            <div class="col-6 col-lg-2">
                                <label for="grupo" class="form-label fw-semibold">
                                    <i class="fas fa-users text-primary me-1"></i> Grupo
                                </label>
                                <select class="form-select form-select-lg" id="grupo" name="grupo">
                                    <option value="">Todos</option>
                                    {% for grupo in grupos %}
                                    <option value="{{ grupo }}" {% if grupo_filtro == grupo %}selected{% endif %}>
                                        Grupo {{ grupo }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Filtro por calidad de ajuste -->
                            <div class="col-6 col-lg-2">
                                <label for="ajuste" class="form-label fw-semibold">
                                    <i class="fas fa-chart-bar text-info me-1"></i> Ajuste
                                </label>
                                <select class="form-select form-select-lg" id="ajuste" name="ajuste">
                                    <option value="">Todos</option>
                                    <option value="excelente" {% if ajuste_filtro == 'excelente' %}selected{% endif %}>⭐ Excelente</option>
                                    <option value="bueno" {% if ajuste_filtro == 'bueno' %}selected{% endif %}>✓ Bueno</option>
                                    <option value="moderado" {% if ajuste_filtro == 'moderado' %}selected{% endif %}>~ Moderado</option>
                                    <option value="debil" {% if ajuste_filtro == 'debil' %}selected{% endif %}>! Débil</option>
                                </select>
                            </div>
                            
                            <!-- Ordenar por -->
                            <div class="col-12 col-lg-2">
                                <label for="ordenar" class="form-label fw-semibold">
                                    <i class="fas fa-sort text-warning me-1"></i> Ordenar por
                                </label>
                                <select class="form-select form-select-lg" id="ordenar" name="ordenar">
                                    <option value="nombre" {% if ordenar == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
                                    <option value="grupo" {% if ordenar == 'grupo' %}selected{% endif %}>Grupo</option>
                                    <option value="r2_desc" {% if ordenar == 'r2_desc' %}selected{% endif %}>Mayor r²</option>
                                    <option value="r2_asc" {% if ordenar == 'r2_asc' %}selected{% endif %}>Menor r²</option>
                                    <option value="crecimiento_desc" {% if ordenar == 'crecimiento_desc' %}selected{% endif %}>↑ Crecimiento</option>
                                    <option value="crecimiento_asc" {% if ordenar == 'crecimiento_asc' %}selected{% endif %}>↓ Crecimiento</option>
                                    <option value="mediciones_desc" {% if ordenar == 'mediciones_desc' %}selected{% endif %}>Más mediciones</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="row g-2">
                            <div class="col-6 col-sm-4 col-lg-2">
                                <button type="submit" class="btn btn-success w-100 btn-lg">
                                    <i class="fas fa-filter me-2"></i>Aplicar
                                </button>
                            </div>
                            <div class="col-6 col-sm-4 col-lg-2">
                                <a href="{% url 'analisis_dashboard' %}" class="btn btn-outline-secondary w-100 btn-lg">
                                    <i class="fas fa-redo me-2"></i>Limpiar
                                </a>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Indicadores de filtros activos -->
                    {% if busqueda or grupo_filtro or ajuste_filtro %}
                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <span class="text-muted fw-semibold">
                                <i class="fas fa-filter me-1"></i> Filtros activos:
                            </span>
                            {% if busqueda %}
                                <span class="badge bg-info rounded-pill">
                                    <i class="fas fa-search me-1"></i> "{{ busqueda }}"
                                </span>
                            {% endif %}
                            {% if grupo_filtro %}
                                <span class="badge bg-primary rounded-pill">
                                    <i class="fas fa-users me-1"></i> Grupo {{ grupo_filtro }}
                                </span>
                            {% endif %}
                            {% if ajuste_filtro %}
                                <span class="badge bg-warning text-dark rounded-pill">
                                    <i class="fas fa-chart-bar me-1"></i> {{ ajuste_filtro|title }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados de la búsqueda -->
    {% if estudiantes_data %}
    <div class="alert alert-success alert-dismissible fade show mb-4 border-0 shadow-sm clearfix" role="alert">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle fa-2x me-3"></i>
            </div>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-1">
                    <strong>{{ total_estudiantes }}</strong> estudiante{{ total_estudiantes|pluralize }} encontrado{{ total_estudiantes|pluralize }}
                </h5>
                <p class="mb-0 small">
                    {% if busqueda or grupo_filtro or ajuste_filtro %}
                        Resultados filtrados con datos suficientes para análisis
                    {% else %}
                        Total de estudiantes con datos suficientes para análisis
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Grid de Tarjetas de Estudiantes -->
    <div class="row g-4 mb-5 clearfix">
        {% for data in estudiantes_data %}
        <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm hover-card border-0">
                <!-- Header de la tarjeta -->
                <div class="card-header bg-gradient-success text-white py-3">
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <div class="flex-grow-1 min-w-0">
                            <h5 class="mb-1 fw-bold text-truncate">
                                <i class="fas fa-user-graduate me-2"></i>
                                {{ data.estudiante.nombre }}
                            </h5>
                            <small class="opacity-75">
                                <i class="fas fa-users me-1"></i> Grupo {{ data.estudiante.grupo }}
                            </small>
                        </div>
                        <div class="flex-shrink-0">
                            {% if data.calidad_ajuste == 'excelente' %}
                            <span class="badge bg-light text-success px-3 py-2">
                                <i class="fas fa-star me-1"></i> Excelente
                            </span>
                            {% elif data.calidad_ajuste == 'bueno' %}
                            <span class="badge bg-light text-info px-3 py-2">
                                <i class="fas fa-check-circle me-1"></i> Bueno
                            </span>
                            {% elif data.calidad_ajuste == 'moderado' %}
                            <span class="badge bg-light text-warning px-3 py-2">
                                <i class="fas fa-minus-circle me-1"></i> Moderado
                            </span>
                            {% else %}
                            <span class="badge bg-light text-secondary px-3 py-2">
                                <i class="fas fa-exclamation-triangle me-1"></i> Débil
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Body de la tarjeta -->
                <div class="card-body p-4">
                    <!-- Estadísticas Principales -->
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-success">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-info">
                                    <h4>{{ data.num_mediciones }}</h4>
                                    <small>Mediciones</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-info">
                                    <i class="fas fa-percent"></i>
                                </div>
                                <div class="stat-info">
                                    <h4>{{ data.r2 }}</h4>
                                    <small>r²</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-warning">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <h4>{{ data.dias_registrados }}</h4>
                                    <small>Días</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-box">
                                <div class="stat-icon bg-primary">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div class="stat-info">
                                    <h4>{{ data.crecimiento_total|floatformat:1 }}</h4>
                                    <small>cm Total</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de Alturas -->
                    <div class="bg-light border rounded p-3 mb-3">
                        <div class="row text-center">
                            <div class="col-6">
                                <i class="fas fa-seedling text-success fs-4 mb-2 d-block"></i>
                                <div class="fw-bold fs-5 text-success">{{ data.altura_inicial|floatformat:1 }} cm</div>
                                <small class="text-muted">Inicial</small>
                            </div>
                            <div class="col-6">
                                <i class="fas fa-tree text-success fs-4 mb-2 d-block"></i>
                                <div class="fw-bold fs-5 text-success">{{ data.altura_final|floatformat:1 }} cm</div>
                                <small class="text-muted">Final</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer con Botones de Acción -->
                <div class="card-footer bg-white border-top p-3">
                    <div class="row g-2">
                        <div class="col-8">
                            <a href="{% url 'analisis_regresion' data.estudiante.id %}" 
                               class="btn btn-success w-100 btn-lg">
                                <i class="fas fa-chart-area me-2"></i>
                                Ver Análisis
                            </a>
                        </div>
                        <div class="col-4">
                            <a href="{% url 'exportar_csv' data.estudiante.id %}" 
                               class="btn btn-outline-success w-100 btn-lg"
                               data-bs-toggle="tooltip"
                               title="Exportar a CSV">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Estudiantes sin Datos Suficientes -->
    {% if estudiantes_sin_datos %}
    <div class="card border-warning shadow mb-4" id="estudiantesSinDatos">
        <div class="card-header bg-warning text-dark">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Estudiantes sin datos suficientes ({{ total_sin_datos }})
                </h5>
                <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEstudiantes" aria-expanded="true">
                    <i class="fas fa-chevron-down" id="toggleIcon"></i>
                </button>
            </div>
        </div>
        <div class="collapse show" id="collapseEstudiantes">
            <div class="card-body">
                <div class="mensaje-permanente mb-3" style="background-color: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 8px;">
                    <i class="fas fa-info-circle me-2" style="color: #664d03;"></i>
                    <strong style="color: #664d03;">Los siguientes estudiantes necesitan al menos 2 mediciones para poder realizar el análisis de regresión lineal.</strong>
                </div>
                <div class="row g-3">
                    {% for data in estudiantes_sin_datos %}
                    <div class="col-12 col-sm-6 col-lg-4">
                        <div class="card border-warning h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <i class="fas fa-user-circle text-warning me-1"></i>
                                            {{ data.estudiante.nombre }}
                                        </h6>
                                        <small class="text-muted d-block">
                                            <i class="fas fa-users me-1"></i> Grupo {{ data.estudiante.grupo }}
                                        </small>
                                    </div>
                                    <span class="badge-fijo badge bg-warning text-dark" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important; background-color: #ffc107 !important; color: #212529 !important; padding: 0.35em 0.65em; border-radius: 0.375rem; font-size: 0.875em;">
                                        {{ data.num_mediciones }} 
                                        {% if data.num_mediciones == 1 %}
                                            medición
                                        {% else %}
                                            mediciones
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <div class="mensaje-estado mb-3" style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 0.875rem;">
                                    <i class="fas fa-exclamation-circle me-1" style="color: #664d03;"></i>
                                    <strong style="color: #664d03;">
                                    {% if data.num_mediciones == 0 %}
                                        Sin mediciones registradas
                                    {% elif data.num_mediciones == 1 %}
                                        Necesita 1 medición más
                                    {% endif %}
                                    </strong>
                                </div>
                                
                                <div class="d-grid">
                                    <a href="{% url 'medicion_crear' %}" class="btn btn-warning">
                                        <i class="fas fa-plus-circle me-1"></i>
                                        Agregar Mediciones
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información Adicional -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        ¿Qué incluye el análisis?
                    </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                    <div class="row g-3">
                        <div class="col-6 col-md-3 text-center">
                            <i class="fas fa-chart-scatter fa-2x fa-md-3x text-success mb-2 mb-md-3"></i>
                            <h6 class="small">Gráfica de Dispersión</h6>
                            <p class="text-muted small mb-0 d-none d-md-block">Visualización de los datos medidos con línea de regresión</p>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <i class="fas fa-calculator fa-2x fa-md-3x text-success mb-2 mb-md-3"></i>
                            <h6 class="small">Ecuación de la Recta</h6>
                            <p class="text-muted small mb-0 d-none d-md-block">Fórmula matemática: y = a₀ + a₁x</p>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <i class="fas fa-percentage fa-2x fa-md-3x text-success mb-2 mb-md-3"></i>
                            <h6 class="small">Coeficientes</h6>
                            <p class="text-muted small mb-0 d-none d-md-block">Valores de r (correlación) y r² (determinación)</p>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <i class="fas fa-table fa-2x fa-md-3x text-success mb-2 mb-md-3"></i>
                            <h6 class="small">Tabla de Datos</h6>
                            <p class="text-muted small mb-0 d-none d-md-block">Listado completo de todas las mediciones</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Sin resultados -->
    <div class="card border-warning shadow-sm mb-4">
        <div class="card-body text-center py-5">
            {% if busqueda or grupo_filtro or ajuste_filtro %}
                <!-- No hay resultados por filtros -->
                <i class="fas fa-search fa-4x text-warning mb-3"></i>
                <h3 class="text-warning mb-3">No se encontraron resultados</h3>
                <p class="text-muted mb-4">
                    No hay estudiantes que coincidan con los filtros aplicados.
                    <br>Intenta ajustar los criterios de búsqueda.
                </p>
                <a href="{% url 'analisis_dashboard' %}" class="btn btn-warning">
                    <i class="fas fa-redo me-2"></i>
                    Limpiar filtros
                </a>
            {% else %}
                <!-- No hay datos en absoluto -->
                <i class="fas fa-chart-line fa-5x text-muted mb-4"></i>
                <h3 class="text-muted">No hay datos disponibles para análisis</h3>
                <p class="text-muted mb-4">
                    Registra al menos 2 mediciones por estudiante para poder realizar el análisis de regresión lineal.
                </p>
                <a href="{% url 'medicion_crear' %}" class="btn btn-success btn-lg">
                    <i class="fas fa-plus-circle me-2"></i>
                    Registrar Mediciones
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Cambiar icono al colapsar/expandir
document.addEventListener('DOMContentLoaded', function() {
    var collapseElement = document.getElementById('collapseEstudiantes');
    if (collapseElement) {
        collapseElement.addEventListener('shown.bs.collapse', function () {
            var icon = document.getElementById('toggleIcon');
            if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        });
        collapseElement.addEventListener('hidden.bs.collapse', function () {
            var icon = document.getElementById('toggleIcon');
            if (icon) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        });
    }
    
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
