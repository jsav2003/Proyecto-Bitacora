{% extends 'registros/base.html' %}
{% load static %}

{% block title %}Análisis de Regresión - {{ estudiante.nombre }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-3">
                <i class="fas fa-chart-line"></i> Análisis de Regresión Lineal
            </h2>
            <div class="alert alert-info">
                <strong>Estudiante:</strong> {{ estudiante.nombre }} | 
                <strong>Grupo:</strong> {{ estudiante.grupo }} | 
                <strong>Mediciones:</strong> {{ num_mediciones }}
            </div>
        </div>
    </div>

    <!-- Gráfica -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-area"></i> Gráfica de Crecimiento</h5>
                </div>
                <div class="card-body text-center">
                    <img src="data:image/png;base64,{{ grafica }}" alt="Gráfica de Regresión" class="img-fluid" style="max-width: 100%;">
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados del Análisis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Ecuación de la Recta</h5>
                </div>
                <div class="card-body">
                    <h3 class="text-center text-primary mb-4">
                        <strong>{{ ecuacion }}</strong>
                    </h3>
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Intercepto (a₀):</strong></td>
                            <td class="text-end">{{ a0 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Pendiente (a₁):</strong></td>
                            <td class="text-end">{{ a1 }}</td>
                        </tr>
                    </table>
                    <hr>
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle"></i> La ecuación representa la mejor línea que se ajusta a los datos medidos.
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-percent"></i> Coeficientes de Correlación</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Coeficiente de Correlación (r):</strong></td>
                            <td class="text-end"><span class="badge bg-info fs-6">{{ r }}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Coeficiente de Determinación (r²):</strong></td>
                            <td class="text-end"><span class="badge bg-success fs-6">{{ r2 }}</span></td>
                        </tr>
                    </table>
                    <hr>
                    <div class="alert alert-light mb-0">
                        <strong>Interpretación:</strong><br>
                        {% if r2 > 0.9 %}
                            <span class="text-success"><i class="fas fa-check-circle"></i> Excelente ajuste lineal (r² > 0.9)</span>
                        {% elif r2 > 0.7 %}
                            <span class="text-info"><i class="fas fa-info-circle"></i> Buen ajuste lineal (r² > 0.7)</span>
                        {% elif r2 > 0.5 %}
                            <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Ajuste moderado (r² > 0.5)</span>
                        {% else %}
                            <span class="text-danger"><i class="fas fa-times-circle"></i> Ajuste débil (r² < 0.5)</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Adicionales -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Estadísticas del Crecimiento</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Altura Inicial</h6>
                                <h4 class="text-primary">{{ altura_inicial }} cm</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Altura Final</h6>
                                <h4 class="text-success">{{ altura_final }} cm</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Crecimiento Total</h6>
                                <h4 class="text-info">{{ altura_final|floatformat:2|add:"-"|add:altura_inicial|floatformat:2|cut:"-" }} cm</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 border rounded">
                                <h6 class="text-muted">Promedio por Día</h6>
                                <h4 class="text-warning">{{ crecimiento_promedio }} cm/día</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Predicción -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow border-{% if puede_predecir %}success{% else %}warning{% endif %}">
                <div class="card-header bg-{% if puede_predecir %}success{% else %}warning{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-crystal-ball"></i> Predicción de Crecimiento
                    </h5>
                </div>
                <div class="card-body">
                    {% if puede_predecir %}
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Información:</strong> Puedes predecir la altura de la planta hasta 5 días adelante del último día registrado.
                            <br><strong>Último día registrado:</strong> Día {{ dia_maximo }}
                            <br><strong>Puedes predecir hasta:</strong> Día {{ dia_max_permitido }}
                        </div>
                        
                        <form method="post" class="row g-3 align-items-end">
                            {% csrf_token %}
                            <div class="col-md-6">
                                <label for="dia_prediccion" class="form-label">
                                    <i class="fas fa-calendar-day"></i> Día a predecir:
                                </label>
                                <input type="number" 
                                       class="form-control form-control-lg" 
                                       id="dia_prediccion" 
                                       name="dia_prediccion" 
                                       min="{{ dia_maximo|add:1 }}" 
                                       max="{{ dia_max_permitido }}"
                                       placeholder="Ingresa el día ({{ dia_maximo|add:1 }} - {{ dia_max_permitido }})"
                                       value="{{ dia_prediccion|default:'' }}"
                                       required>
                                <div class="form-text">
                                    Ingresa un día entre {{ dia_maximo|add:1 }} y {{ dia_max_permitido }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-calculator"></i> Calcular Predicción
                                </button>
                            </div>
                        </form>

                        {% if altura_prediccion %}
                        <div class="mt-4">
                            <div class="alert alert-success border-success" role="alert">
                                <h5 class="alert-heading">
                                    <i class="fas fa-check-circle"></i> Resultado de la Predicción
                                </h5>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Día Predicho</h6>
                                        <h3 class="text-success"><i class="fas fa-calendar"></i> Día {{ dia_prediccion }}</h3>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Altura Predicha</h6>
                                        <h3 class="text-primary"><i class="fas fa-ruler-vertical"></i> {{ altura_prediccion }} cm</h3>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Fórmula Utilizada</h6>
                                        <h5 class="text-muted">y = {{ a0|floatformat:2 }} + {{ a1|floatformat:2 }}({{ dia_prediccion }})</h5>
                                    </div>
                                </div>
                                <hr>
                                <p class="mb-0 small">
                                    <i class="fas fa-lightbulb"></i> <strong>Nota:</strong> 
                                    Esta predicción está basada en el modelo de regresión lineal. 
                                    La precisión depende de qué tan lineal sea el crecimiento real de la planta.
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning mb-0">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> Datos Insuficientes para Predicción
                            </h5>
                            <p class="mb-2">
                                Se necesitan <strong>al menos 7 mediciones</strong> para realizar predicciones confiables.
                            </p>
                            <p class="mb-0">
                                <strong>Mediciones actuales:</strong> {{ num_mediciones }} de 7 requeridas
                            </p>
                            <div class="progress mt-3" style="height: 25px;">
                                <div class="progress-bar bg-warning" 
                                     role="progressbar" 
                                     id="progress-mediciones"
                                     aria-valuenow="{{ num_mediciones }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="7">
                                    {{ num_mediciones }}/7
                                </div>
                            </div>
                            <script>
                                document.getElementById('progress-mediciones').style.width = '{{ porcentaje_progreso }}%';
                            </script>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Datos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-table"></i> Datos de Mediciones</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Día</th>
                                    <th>Altura (cm)</th>
                                    <th>Fecha de Registro</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for medicion in mediciones %}
                                <tr>
                                    <td><strong>{{ medicion.dia }}</strong></td>
                                    <td>{{ medicion.altura }}</td>
                                    <td>{{ medicion.fecha_registro|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <a href="{% url 'exportar_csv' estudiante.id %}" class="btn btn-success btn-lg me-2">
                <i class="fas fa-download"></i> Exportar a CSV
            </a>
            <a href="{% url 'medicion_listar' %}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Volver a Mediciones
            </a>
        </div>
    </div>
</div>
{% endblock %}
