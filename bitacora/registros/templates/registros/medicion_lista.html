{% extends 'registros/base.html' %}

{% block title %}Mediciones de Plantas - Bitácora Científica{% endblock %}

{% block breadcrumb %}
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'index' %}"><i class="bi bi-house-fill"></i> Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Mediciones</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Encabezado -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div class="flex-grow-1">
        <h2 class="mb-2">
            <i class="bi bi-bar-chart-fill text-success"></i> Mediciones de Plantas
        </h2>
        <p class="text-muted mb-0">
            <span class="badge badge-count bg-success">{{ mediciones.count }}</span> 
            medición(es) registrada(s)
        </p>
    </div>
    <div class="w-100 w-md-auto">
        <a href="{% url 'medicion_crear' %}" class="btn btn-success btn-lg shadow w-100">
            <i class="bi bi-plus-circle-fill me-2"></i> Nueva Medición
        </a>
    </div>
</div>

<!-- Filtro por Estudiante -->
{% if estudiantes %}
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-12">
                <label class="form-label mb-2">
                    <i class="bi bi-funnel-fill me-2"></i> Filtrar por estudiante:
                </label>
            </div>
            <div class="col-md-7 col-12">
                <select name="estudiante" class="form-select" id="estudianteSelect">
                    <option value="">🔍 Todos los estudiantes</option>
                    {% for estudiante in estudiantes %}
                        <option value="{{ estudiante.id }}" 
                                {% if estudiante.id|stringformat:"s" == estudiante_seleccionado %}selected{% endif %}>
                            👤 {{ estudiante.nombre }} - 📚 Grupo {{ estudiante.grupo }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5 col-12">
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-success flex-fill">
                        <i class="bi bi-search me-2"></i> Filtrar
                    </button>
                    {% if estudiante_seleccionado %}
                    <a href="{% url 'medicion_listar' %}" class="btn btn-outline-secondary flex-fill">
                        <i class="bi bi-x-circle me-2"></i> Limpiar
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Banner de Análisis -->
<div class="banner-analisis-fijo mb-4" role="alert" style="background: linear-gradient(135deg, #198754 0%, #20c997 100%); border: none; border-radius: 12px; padding: 20px; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); opacity: 1 !important; visibility: visible !important; display: block !important;">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h5 class="mb-2" style="color: white; font-weight: 600; opacity: 1 !important; visibility: visible !important;">
                <i class="bi bi-graph-up-arrow me-2"></i>
                ¿Necesitas analizar el crecimiento?
            </h5>
            <p class="mb-0" style="color: rgba(255,255,255,0.95); opacity: 1 !important; visibility: visible !important;">
                Visualiza gráficas de regresión lineal, calcula coeficientes de correlación y exporta datos a CSV.
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'analisis_dashboard' %}" class="btn btn-light btn-lg" style="opacity: 1 !important; visibility: visible !important; display: inline-block !important;">
                <i class="bi bi-bar-chart-line me-2"></i>
                Ir a Análisis
            </a>
        </div>
    </div>
</div>
{% endif %}

{% if mediciones %}
<!-- Vista de Cards para Móviles -->
<div class="mediciones-cards-view">
    {% for item in mediciones_con_fotos %}
    <div class="medicion-card">
        <div class="medicion-card-header">
            <div>
                <div class="medicion-card-title">
                    <i class="bi bi-person-circle text-success me-2"></i>
                    {{ item.medicion.estudiante.nombre }}
                </div>
                <div class="medicion-card-subtitle">
                    <span class="badge bg-success text-white">
                        <i class="bi bi-mortarboard-fill me-1"></i> Grupo {{ item.medicion.estudiante.grupo }}
                    </span>
                </div>
            </div>
            <div class="medicion-card-day">
                <div style="font-size: 0.75rem; opacity: 0.8;">Día</div>
                {{ item.medicion.dia }}
            </div>
        </div>
        
        <div class="medicion-card-body">
            <div class="medicion-card-info">
                <div class="medicion-card-label">
                    <i class="bi bi-rulers me-1"></i> Altura
                </div>
                <div class="medicion-card-value">
                    {{ item.medicion.altura }} <small>cm</small>
                </div>
            </div>
            
            <div class="medicion-card-info">
                <div class="medicion-card-label">
                    <i class="bi bi-clock me-1"></i> Fecha
                </div>
                <div style="font-size: 0.9rem; font-weight: 600; color: #495057; margin-top: 0.25rem;">
                    {{ item.medicion.fecha_registro|date:"d/m/Y" }}<br>
                    <small style="font-size: 0.8rem; color: #6c757d;">{{ item.medicion.fecha_registro|date:"H:i" }}</small>
                </div>
            </div>
            
            {% if item.foto %}
            <div class="medicion-card-photo">
                <div class="medicion-card-label mb-2">
                    <i class="bi bi-camera-fill me-1"></i> Fotografía
                </div>
                <a href="{{ item.foto.imagen.url }}" target="_blank">
                    <img src="{{ item.foto.imagen.url }}" 
                         alt="Foto día {{ item.medicion.dia }}"
                         loading="lazy">
                </a>
                {% if item.foto.comentario %}
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-chat-left-text-fill me-1"></i>
                        {{ item.foto.comentario }}
                    </small>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="medicion-card-photo">
                <div class="no-photo">
                    <i class="bi bi-camera-video-off fs-2"></i>
                    <p class="mb-0 mt-2 small">Sin fotografía</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="medicion-card-footer">
            <div class="medicion-card-date">
                <i class="bi bi-hash"></i> ID: {{ item.medicion.id }}
            </div>
            <div class="medicion-card-actions">
                <a href="{% url 'medicion_editar' item.medicion.pk %}" 
                   class="btn btn-sm btn-warning">
                    <i class="bi bi-pencil-fill"></i> Editar
                </a>
                <a href="{% url 'medicion_eliminar' item.medicion.pk %}" 
                   class="btn btn-sm btn-danger btn-delete"
                   data-name="Medición día {{ item.medicion.dia }} - {{ item.medicion.estudiante.nombre }}">
                    <i class="bi bi-trash-fill"></i> Eliminar
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Tabla con DataTables para Escritorio -->
<div class="mediciones-table-view">
<div class="table-container">
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered table-datatable" id="medicionesTable">
        <thead>
            <tr>
                <th><i class="bi bi-hash"></i> ID</th>
                <th><i class="bi bi-person-fill"></i> Estudiante</th>
                <th><i class="bi bi-bookmark-fill"></i> Grupo</th>
                <th><i class="bi bi-calendar-day-fill"></i> Día</th>
                <th><i class="bi bi-rulers"></i> Altura (cm)</th>
                <th><i class="bi bi-camera-fill"></i> Foto</th>
                <th><i class="bi bi-clock-fill"></i> Fecha Registro</th>
                <th class="text-center"><i class="bi bi-gear-fill"></i> Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for item in mediciones_con_fotos %}
            <tr>
                <td class="fw-bold">{{ item.medicion.id }}</td>
                <td>
                    <i class="bi bi-person-circle text-success me-2"></i>
                    {{ item.medicion.estudiante.nombre }}
                </td>
                <td>
                    <span class="badge bg-success text-white">
                        <i class="bi bi-mortarboard-fill me-1"></i> Grupo {{ item.medicion.estudiante.grupo }}
                    </span>
                </td>
                <td>
                    <span class="badge bg-success">
                        <i class="bi bi-calendar3 me-1"></i> Día {{ item.medicion.dia }}
                    </span>
                </td>
                <td>
                    <strong class="text-success fs-5">{{ item.medicion.altura }}</strong> cm
                </td>
                <td class="text-center">
                    {% if item.foto %}
                        <a href="{{ item.foto.imagen.url }}" target="_blank" data-bs-toggle="tooltip" title="Ver fotografía completa">
                            <img src="{{ item.foto.imagen.url }}" 
                                 alt="Foto día {{ item.medicion.dia }}" 
                                 class="img-thumbnail"
                                 style="max-width: 60px; max-height: 60px; object-fit: cover; cursor: pointer;">
                        </a>
                        {% if item.foto.comentario %}
                            <br><small class="text-muted" data-bs-toggle="tooltip" title="{{ item.foto.comentario }}">
                                <i class="bi bi-chat-left-text-fill"></i>
                            </small>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">
                            <i class="bi bi-camera-video-off"></i> Sin foto
                        </span>
                    {% endif %}
                </td>
                <td>
                    <i class="bi bi-clock text-muted me-1"></i>
                    {{ item.medicion.fecha_registro|date:"d/m/Y H:i" }}
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <a href="{% url 'medicion_editar' item.medicion.pk %}" 
                           class="btn btn-sm btn-warning btn-action" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Editar medición">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                        <a href="{% url 'medicion_eliminar' item.medicion.pk %}" 
                           class="btn btn-sm btn-danger btn-action btn-delete" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Eliminar medición"
                           data-name="Medición día {{ item.medicion.dia }} - {{ item.medicion.estudiante.nombre }}">
                            <i class="bi bi-trash-fill"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>
</div>

<!-- Estadísticas Rápidas -->
<div class="row mt-4">
    <div class="col-md-6 mb-3">
        <div class="card border-success text-center">
            <div class="card-body">
                <i class="bi bi-graph-up-arrow fs-1 text-success"></i>
                <h5 class="mt-2">Progreso del Experimento</h5>
                <p class="text-muted">Seguimiento diario del crecimiento con fotografías</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card border-success text-center">
            <div class="card-body">
                <i class="bi bi-people-fill fs-1 text-success"></i>
                <h5 class="mt-2">Estudiantes</h5>
                <p class="text-muted">Gestionar participantes del experimento</p>
                <a href="{% url 'estudiante_listar' %}" class="btn btn-sm btn-outline-success mt-2">
                    Ver Estudiantes
                </a>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Estado Vacío -->
<div class="empty-state">
    <i class="bi bi-bar-chart-line"></i>
    <h3>No hay mediciones registradas</h3>
    <p class="text-muted mb-4">Comienza a registrar las mediciones diarias de tus plantas</p>
    <a href="{% url 'medicion_crear' %}" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle-fill me-2"></i> Registrar Primera Medición
    </a>
</div>
{% endif %}

<style>
/* Protección para el banner de análisis */
.banner-analisis-fijo,
.banner-analisis-fijo * {
    opacity: 1 !important;
    visibility: visible !important;
    animation: none !important;
    transition: none !important;
}

.banner-analisis-fijo {
    display: block !important;
}

.banner-analisis-fijo .btn {
    display: inline-block !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Proteger el banner de análisis
    var banner = document.querySelector('.banner-analisis-fijo');
    if (banner) {
        // Remover cualquier atributo que pueda ocultar
        banner.removeAttribute('data-bs-dismiss');
        banner.removeAttribute('data-dismiss');
        banner.removeAttribute('data-bs-autohide');
        
        // Forzar visibilidad
        banner.style.opacity = '1';
        banner.style.visibility = 'visible';
        banner.style.display = 'block';
        
        // Proteger todos los elementos dentro del banner
        var elementosDentro = banner.querySelectorAll('*');
        elementosDentro.forEach(function(elemento) {
            elemento.style.opacity = '1';
            elemento.style.visibility = 'visible';
        });
        
        // Observador para detectar cambios
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.target === banner) {
                    banner.style.opacity = '1';
                    banner.style.visibility = 'visible';
                    banner.style.display = 'block';
                }
            });
        });
        
        observer.observe(banner, {
            attributes: true,
            attributeFilter: ['style', 'class', 'hidden']
        });
    }
});
</script>
{% endblock %}
